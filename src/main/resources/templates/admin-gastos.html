<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gastos Admin</title>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <style>
      body {
        background-image: url("https://drive.google.com/thumbnail?id=1HulCrn-LlhROS6nb-jCkdvubxTRp1QDy&sz=w1000");
        background-size: contain;
      }
      .navbar {
        background-color: #1BB521;
      }
      .agrupacion {
        font-size: 1.3rem;
      }
      i {
        font-size: 2.2rem;
      }
      /* Main */
      h2 {
        margin-top: -3rem;
      }
      .caja {
        background-color: #8EC1E3;
        border-radius: 10px;
        width: 400px; /* Ancho fijo para evitar que cambie */
        padding: 5rem;
      }
      .boton:hover {
        /*background-color: #0002;*/
        opacity: 0.9;
      }
      /* Sweet Alert */
      .fondo {
        background-color: #8EC1E3;
        border-radius: 10px;
        height: 20rem;
      }
      .inputs {
        width: 50%;
        border-top: none;
        border-left: none;
        border-right: none;
        background-color: #8EC1E3;
        color: black;
        margin-top: 1rem;
      }
      .inputs:focus {
        text-decoration: none;
        outline: none;
      }
      /* .boton-cancelar {
        background-color: #1BB521;
        border: none;
        border-radius: 10px;
        width: 7.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        margin-top: -1rem;
      } */
      .boton-cancelar:hover {
        opacity: 0.8;
      }

      .eliminar {
        background-color: #B51B1B;
        color: white;
      }

      .boton-cancelar {
        background-color: red;
      }
      .boton-cancelar:hover {
        opacity: 0.8;
      }

      .boton-confirmar{
        background-color: #0baa10;
      }

      .boton-confirmar:hover {
        opacity: 0.8;
      }

      .boton-eliminar-cancelar{
        background-color: grey;
        color: white;
      }

      .boton-eliminar{
        background-color: #b43939;
        color: white;
      }

      #eliminar {
        background-color: #b43939;
        color: white;
        width: 12rem;
      }

      #editar{
        background-color: rgb(186, 194, 77);
        color: white;
        width: 12rem;
      }

      #nueva{
        background-color: #33c438;
        color: white;
        width: 12rem;
      }

      #eliminar:hover{
        opacity: 0.8;
      }

      #editar:hover{
        opacity: 0.8;
      }

      #nueva:hover{
        opacity: 0.8;
      }

      /* Estilos del menú desplegable */
      .dropdown-menu {
          background-color:#da3131; /* Color de fondo del menú */
          border-radius: 0.5rem; /* Bordes redondeados */
          box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* Sombra del menú */
      }

      .dropdown-item {
          color: #333; /* Color del texto */
      }

      .dropdown-item:hover {
          background-color: #da3131; /* Color de fondo al pasar el mouse */
          color: #000; /* Color del texto al pasar el mouse */
      }

      .dropdown-item:focus {
          background-color: #cbd444; /* Color de fondo al estar en foco */
          color: #000; /* Color del texto al estar en foco */
      }
      .custom-popup {
          justify-content: center; /* Centra horizontalmente */
          align-items: center; /* Centra verticalmente */
      }
    </style>

  <nav class="navbar">
    <div class="container-fluid">
        <button onclick="volver()" class="btn rounded-fill">
            <i id="dl-icon" class="bi bi-house-fill"></i>
        </button>

        <!-- Dropdown de Admin con Logout -->
        <div class="dropdown ms-auto">
            <a class="navbar-brand d-flex align-items-center agrupacion dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <p class="mb-0">Admin</p>
                <i class="bi bi-person-circle ms-2"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                <li><button class="dropdown-item" onclick="logout()" id="logoutButton">CERRAR SESION</button></li>
            </ul>
        </div>
    </div>
  </nav>
  
    <!-- Main -->
    <div class="d-flex justify-content-center align-items-center" style="margin-top: 7rem;">
      <div class="caja text-center">
        <h2 class="mb-5">GASTOS</h2>
        <div>
          <button class="btn mb-4 boton" id="nueva">AGREGAR CATEGORIA</button>
        </div>
        <div>
          <button class="btn mb-3 boton" id="editar">EDITAR CATEGORIA</button>
        </div>
        <div>
          <button class="btn mt-1 boton boton-editable" id="eliminar">ELIMINAR CATEGORIA</button>
        </div>       
      </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="../PANTALLA DE INICIO/js/temaOscuro.js"></script>

    <!-- Sweet Alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
<script>

document.getElementById("logoutButton").addEventListener("click", function(event) {
          event.preventDefault(); // Evita la redirección inmediata
          // Muestra el SweetAlert en lugar de confirm
          Swal.fire({
              title: "¿Deseas cerrar la sesión?",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Sí, cerrar sesión',
              cancelButtonText: 'Cancelar',
              customClass: {
                  popup: 'custom-popup' // Añade una clase personalizada
              }
          }).then((result) => {
              if (result.isConfirmed) {
                fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                  window.location.href = "/login";
              }
          });
      });

    function volver(){
    window.location.href = "/home-admin";
  }

    document.getElementById('nueva').addEventListener('click', function(event) {
    event.preventDefault(); // Evita el comportamiento predeterminado del enlace

    Swal.fire({
        title: "AGREGAR CATEGORIA",
        html: '<input id="nombreCategoria" type="text" placeholder="NOMBRE DE LA CATEGORIA" class="inputs" minlength="4" style="width: 20rem; margin-top:2rem;" required>',
        showConfirmButton: true,
        showCancelButton: true,
        showCloseButton: true,
        focusConfirm: false,
        confirmButtonText: 'AGREGAR',
        cancelButtonText: `CANCELAR`,
        customClass: {
            popup: 'fondo',
            confirmButton: 'boton-confirmar',
            cancelButton: 'boton-cancelar'
        },
        preConfirm: () => {
            const nombre = document.getElementById('nombreCategoria').value;

            if(nombre.length === 0){
                Swal.showValidationMessage("Complete este campo");
                return false; // Asegura que no continúa si hay error
            }

            // Validación de longitud de nombre
            if (nombre.length < 4 || nombre.length > 20) {
                Swal.showValidationMessage("El nombre de la categoría debe tener entre 4 y 20 caracteres");
                return; // Evita continuar si la validación falla
            }

            // Mostrar mensaje de confirmación antes de proceder con la solicitud
            return Swal.fire({
                title: '¿Estás seguro?',
                text: `Estás a punto de agregar la categoría "${nombre}".`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, agregar',
                cancelButtonText: 'Cancelar'
            }).then(confirmResult => {
                if (confirmResult.isConfirmed) {
                    // Realizar la petición al servidor si el usuario confirma
                    return fetch('/home-admin/gastos/crear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded', // Tipo de contenido
                        },
                        body: new URLSearchParams({ nombre }) // Convertimos el nombre a parámetros de URL
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Maneja diferentes tipos de respuesta de error
                            if (response.status === 409) {
                                throw new Error("El nombre de la categoría ya existe");
                            } else {
                                throw new Error("Error al crear la categoría: " + response.statusText);
                            }
                        }
                        return response.text(); // Devuelve la respuesta como texto
                    })
                    .catch(error => {
                        Swal.fire('¡Error!', error.message, 'error'); // Muestra el error en un Swal
                        return false; // Evita que se cierre el modal
                    });
                }
            });
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Aquí puedes manejar la respuesta de éxito si es necesario
            Swal.fire('¡Éxito!', 'Categoría agregada correctamente.', 'success');
        }
    });
});

    document.getElementById('editar').addEventListener('click', function(event) {
    event.preventDefault(); // Evita el comportamiento predeterminado del enlace

    // Hacer una petición para obtener las categorías
    fetch('http://localhost:8080/backof/categorias-gasto/all')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener las categorías');
            }
            return response.json(); // Suponiendo que la respuesta es un JSON
        })
        .then(data => {
            // Acceder al array de categorías en la propiedad 'data'
            let options = data.data.map(categoria => `<option value="${categoria.id}">${categoria.nombre}</option>`).join('');
            let selectHTML = `
                <select id="categoriaSelect" class="inputs" style="width: 20rem; margin-bottom: 10px;">
                    <option value="" disabled selected>SELECCIONE UNA CATEGORIA</option>
                    ${options}
                </select>
                <input id="nuevoNombre" type="text" placeholder="NUEVO NOMBRE DE LA CATEGORIA" class="inputs" style="width: 20rem;">
            `;

            // Mostrar la alerta de SweetAlert para editar
            Swal.fire({
                title: "EDITAR CATEGORIA",
                html: selectHTML,
                showConfirmButton: true,
                showCloseButton: true,
                showCancelButton: true,
                focusConfirm: false,
                customClass: {
                    popup: 'fondo',
                    confirmButton: 'boton-confirmar',
                    cancelButton: 'boton-cancelar',
                    CloseButton: 'boton-cerrar',
                },
                cancelButtonText: `CANCELAR`,
                confirmButtonText: 'EDITAR',
                preConfirm: () => {
                    const categoriaId = document.getElementById('categoriaSelect').value;
                    const nuevoNombre = document.getElementById('nuevoNombre').value;

                    // Validación de la categoría seleccionada y nombre
                    if (!categoriaId) {
                        Swal.showValidationMessage('Por favor, seleccione una categoría.');
                        return false; // Impide la confirmación si la categoría no está seleccionada
                    }
                    if (!nuevoNombre) {
                        Swal.showValidationMessage('Por favor, ingrese un nuevo nombre.');
                        return false; // Impide la confirmación si el nombre no está ingresado
                    }

                    if (nuevoNombre.length < 4 || nuevoNombre.length > 20) {
                        Swal.showValidationMessage("El nombre de la categoría debe tener entre 4 y 20 caracteres");
                        return;
                    }

                    // Confirmar antes de proceder
                    return { categoriaId, nuevoNombre }; // Devolvemos los valores para el siguiente paso
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { categoriaId, nuevoNombre } = result.value;

                    // Mostrar un mensaje de confirmación antes de enviar la solicitud
                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: `Se va a cambiar el nombre de la categoría a: "${nuevoNombre}"`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, editar',
                        cancelButtonText: 'Cancelar'
                    }).then((confirmResult) => {
                        if (confirmResult.isConfirmed) {
                            // Enviar la solicitud para editar la categoría al backend
                            fetch('/home-admin/gastos/editar', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ nombre: nuevoNombre, id: categoriaId })
                            })
                            .then(response => {
                                if (response.ok) {
                                    return response.text();
                                } else if (response.status === 403) {
                                    throw new Error('El nombre de la categoría ya existe');
                                } else {
                                    throw new Error('Error al editar la categoría');
                                }
                            })
                            .then(message => {
                                Swal.fire('¡Éxito!', message, 'success');
                            })
                            .catch(error => {
                                Swal.fire('Error', error.message, 'error');
                            });
                        }
                    });
                }
            });
        })
        .catch(error => {
            Swal.fire('Error', error.message, 'error'); // Manejo de errores
        });
});

    document.getElementById('eliminar').addEventListener('click', function(event) {
      event.preventDefault(); // Evita el comportamiento predeterminado del enlace

      // Hacer una petición para obtener las categorías
      fetch('http://localhost:8080/backof/categorias-gasto/all')
          .then(response => {
              if (!response.ok) {
                  throw new Error('Error al obtener las categorías');
              }
              return response.json(); // Suponiendo que la respuesta es un JSON
          })
          .then(data => {
              // Acceder al array de categorías en la propiedad 'data'
              let options = data.data.map(categoria => `<option value="${categoria.id}">${categoria.nombre}</option>`).join('');
              let selectHTML = `
                  <select id="categoriaEliminar" class="inputs" style="width: 20rem; margin-bottom: 10px;">
                      <option value="" disabled selected>SELECCIONE UNA CATEGORIA</option>
                      ${options}
                  </select>
              `;

              // Mostrar la alerta de SweetAlert para eliminar
              Swal.fire({
                  title: "ELIMINAR CATEGORIA",
                  html: selectHTML,
                  showConfirmButton: true,
                  showCloseButton: true,
                  showCancelButton: true,
                  focusConfirm: false,
                  customClass: {
                      popup: 'fondo',
                      confirmButton: 'boton-eliminar',
                      cancelButton: 'boton-eliminar-cancelar',
                  },
                  confirmButtonText: 'ELIMINAR',
                  cancelButtonText: 'CANCELAR',
                  preConfirm: () => {
                      const categoriaId = document.getElementById('categoriaEliminar').value;

                      if (!categoriaId) {
                          Swal.showValidationMessage('Por favor, seleccione una categoría para eliminar.');
                          return false;
                      }
                      return categoriaId;
                  }
              }).then((result) => {
                  if (result.isConfirmed) {
                      const categoriaId = result.value;

                      // Mostrar un mensaje de confirmación antes de eliminar
                      Swal.fire({
                          title: '¿Estás seguro?',
                          text: `Se eliminará la categoría seleccionada.`,
                          icon: 'warning',
                          showCancelButton: true,
                          confirmButtonText: 'Sí, eliminar',
                          cancelButtonText: 'Cancelar'
                      }).then((confirmResult) => {
                          if (confirmResult.isConfirmed) {
                              // Enviar la solicitud para eliminar la categoría al backend
                              fetch(`/home-admin/gastos/eliminar`, {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json',
                                  },
                                  body: JSON.stringify({ id: categoriaId })
                              })
                              .then(response => {
                                  if (response.ok) {
                                      return response.text();
                                  } else if (response.status === 404) {
                                      throw new Error('La categoría no existe');
                                  } else if (response.status === 409) {
                                      throw new Error('No se puede eliminar la categoría porque está asociada a gastos existentes.');
                                  } else {
                                      throw new Error('Error al eliminar la categoría');
                                  }
                              })
                              .then(message => {
                                  Swal.fire('¡Éxito!', message, 'success');
                              })
                              .catch(error => {
                                  Swal.fire('Error', error.message, 'error');
                              });
                          }
                      });
                  }
              });
          })
          .catch(error => {
              Swal.fire('Error', error.message, 'error'); // Manejo de errores
          });
  });
</script>
